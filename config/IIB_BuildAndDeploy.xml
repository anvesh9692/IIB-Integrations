<?xml version="1.0"?>
<project name="IIB_BUILD" default="main" basedir=".">

<!--
  Build file to be used by Development Team to pack and deploy the release
    Tasks done by this script are:
    1. Override bar files for deployment from respective property files
    2. Deploy the bar files on respective EGs
    3. Activate flow monitoring for respective EGs
-->

<!--
  Version History
  Ver No   Date             Author          Remarks
  1.0      13/Mar/2018      Ravi Patel      Initial version
  1.1      26/Mar/2018      Ravi Patel      Updated script for environment specific BarFile name and activating flow monitoring
  
-->
<!--
<taskdef resource="net/sf/antcontrib/antlib.xml" />
<taskdef resource="net/sf/antcontrib/antcontrib.properties" classpath="ant-contrib-1.0b3.jar" />
-->
<!-- Load the Property Files -->
<loadproperties srcFile="config/deploy_props.properties" />

<!-- Setting the timestamp pattern -->
<macrodef  name="set.timestamp">
  <sequential>
    <tstamp>
      <format property="current.time" pattern="yyyyMMddhhmm" />
    </tstamp>
  </sequential>
</macrodef>

<target name="main" description="default target">
  <set.timestamp />
  <mkdir dir="deploymentLogs" />
  <record name="deploymentLogs/deploymentLog_${current.time}.log" action="start" />
  
  <antcall target="welcomePage" />
  
  <antcall target="deployBar" />
  
  <antcall target="goodByePage" />
</target>

<!-- Starting to write the Targets for ANT -->

<target name="welcomePage">
  <!-- Greet the User!!! -->
  <echo message="*************************************************"/>
  <echo message="****                                         ****"/>
  <echo message="****   Welcome to IIB Build and Deploy Tool  ****"/>
  <echo message="****                                         ****"/>
  <echo message="*************************************************"/>
</target>

<target name="deployBar">
  <echo message="" />
  <echo message="Overriding the bar files for ${env} and deploying on respective EGs" />
  
  <!-- Loading the property files -->
  <property file="config/flow_eg_mapper.properties" prefix="flow_eg_mapper." />
  <!--<propertyselector property="flow_eg_mapper" match="flow_eg_mapper\.(.*)" select="\1" />-->
  <loadproperties srcFile="config/flow_eg_mapper.properties" />
  
  <property file="config/deploy_flags.properties" />
  
  <echo message="" />
  <echo message="Checking FLAGs for each BarFiles for deployment" />
  <echo message="BarFiles having FLAGs = Y only will be deployed" />
  <echo message="" />
  
  <delete dir="${deploypath}/deployed_apps"/> 
  <mkdir dir="${deploypath}/deployed_apps"/> 
	
  <for list="${flow_eg_mapper}" param="flowEG">
    <sequential>
      <!-- Check for FLAGs that are to be deployed -->
      <if>
        <or>
          <equals arg1="${@{flowEG}_FLAG}" arg2="y" />
          <equals arg1="${@{flowEG}_FLAG}" arg2="Y" />
        </or>
        <then>
          <!-- Overriding properties for BarFile -->
          <echo message="Overriding properties for @{flowEG}.bar" />
          <echo message="mqsiapplybaroverride -b ${deploypath}/@{flowEG}.bar -p overrides/${env}/@{flowEG}.properties" />
          <echo message="" />
          
          <exec executable="mqsiapplybaroverride" spawn="false" failonerror="true">
            <arg value="-b" />
            <arg value="${deploypath}/@{flowEG}.bar" />
            <arg value="-p" />
            <arg value="overrides/${env}/@{flowEG}.properties" />
          </exec>
          
          <echo message="@{flowEG}.bar file configured successfully" />
          <echo message="" />
          
          <!-- Deploying BarFile -->
          <echo message="Deploying @{flowEG}.bar on ${@{flowEG}} EG" />
          <echo message="mqsideploy ${broker_name} -e ${@{flowEG}} -a ${deploypath}/@{flowEG}_.bar -w 180" />
          <echo message="" />
          
          <exec executable="mqsideploy" spawn="false" failonerror="true">
            <arg value="${broker_name}" />
            <arg value="-e" />
            <arg value="${@{flowEG}}" />
            <arg value="-a" />
            <arg value="${deploypath}/@{flowEG}.bar" />
            <arg value="-w" />
            <arg value="180" />
          </exec>
          
          <echo message="@{flowEG}.bar file deployed successfully" />
          <echo message="" />
          
		  <echo message="move @{flowEG}.bar file to ${deploypath}/deployed_apps" />
          <echo message="" />

		  <move file="${deploypath}/@{flowEG}.bar" todir="${deploypath}/deployed_apps" failonerror="false"/>
		  
          <!-- Activate Flow Monitoring -->
          <echo message="Activating flow monitoring on ${@{flowEG}} EG" />
          <echo message="mqsichangeflowmonitoring ${broker_name} -e ${@{flowEG}} -c active -j" />
          <echo message="" />
          
          <exec executable="mqsichangeflowmonitoring" spawn="false" failonerror="true">
            <arg value="${broker_name}" />
            <arg value="-e" />
            <arg value="${@{flowEG}}" />
            <arg value="-c" />
            <arg value="active" />
            <arg value="-j" />
          </exec>
          
          <echo message="Flow monitoring on ${@{flowEG}} EG activated successfully" />
          <echo message="" />
        </then>
      </if>
    </sequential>
  </for>  
	<!-- stop all flows in broker, it's for first time prod deployment -->
	<!-- should use bar file overwrite to set individul bar file
	<echo message="start_flow set to ${start_flow}" />
	<echo message="" />
	<if>
		<or>
		<equals arg1="${start_flow}" arg2="N" />
		<equals arg1="${start_flow}" arg2="n" />
		</or>
	<then>
		<echo message="stop all flows in broker" />
		<echo message="" />
	    <exec executable="mqsistopmsgflow" spawn="false" failonerror="true">
            <arg value="${broker_name}" />
            <arg value="-g" />
          </exec>
	</then>
	</if> -->
</target>

<target name="goodByePage">
  <echo message="********************************************"/>
  <echo message="****                                    ****"/>
  <echo message="****        Thank you for using         ****"/>
  <echo message="****     IIB Build and Deploy Tool      ****"/>
  <echo message="****                                    ****"/>
  <echo message="********************************************"/>
</target>

</project>
